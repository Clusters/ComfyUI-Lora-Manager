<!DOCTYPE html>
<html>
<head>
    <title>LoRA Recipes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/loras_static/css/style.css">
    <link rel="stylesheet" href="/loras_static/css/components/recipe-card.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
    <link rel="icon" type="image/png" sizes="32x32" href="/loras_static/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/loras_static/images/favicon-16x16.png">
    <link rel="manifest" href="/loras_static/images/site.webmanifest">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="/loras_static/css/style.css" as="style">
    <link rel="preload" href="/loras_static/js/recipes.js" as="script" crossorigin="anonymous">
    
    <!-- Optimize font loading -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin>
    
    <!-- Performance monitoring -->
    <script>
        performance.mark('page-start'); 
        window.addEventListener('load', () => {
            performance.mark('page-end');
            performance.measure('page-load', 'page-start', 'page-end');
        });
    </script>
    
    <!-- Security meta tags -->
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
    
    <!-- Resource loading strategy -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">

    <style>
        /* Recipe-specific styles */
        .recipe-tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .recipe-tag {
            background: var(--lora-surface-hover);
            color: var(--lora-text-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius-sm);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .recipe-tag:hover, .recipe-tag.active {
            background: var(--lora-primary);
            color: var(--lora-text-on-primary);
        }

        .recipe-card {
            position: relative;
            background: var(--lora-surface);
            border-radius: var(--border-radius-base);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }
        
        .recipe-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        .recipe-indicator {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 24px;
            height: 24px;
            background: var(--lora-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            z-index: 2;
        }
        
        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .placeholder-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 2rem;
            background: var(--lora-surface-alt);
            border-radius: var(--border-radius-base);
        }
    </style>
</head>
<body>
    {% include 'components/header.html' %}

    <div class="page-content">
        {% include 'components/modals.html' %}
        {% include 'components/loading.html' %}
        {% include 'components/context_menu.html' %}

        <div class="container">
            {% if is_initializing %}
            <div class="initialization-notice">
                <div class="notice-content">
                    <div class="loading-spinner"></div>
                    <h2>Initializing Recipe Manager</h2>
                    <p>Scanning and building recipe cache. This may take a few moments...</p>
                </div>
            </div>
            {% else %}           
            <!-- Recipe controls - can reuse structure from loras controls -->
            <div class="controls">
                <!-- Recipe tags container - similar to folder tags -->
                <div class="folder-tags-container">
                    <div class="recipe-tag-container">
                        {% if recipe_tags %}
                            {% for tag in recipe_tags %}
                            <div class="recipe-tag" data-tag="{{ tag }}">{{ tag }}</div>
                            {% endfor %}
                        {% else %}
                            <div class="recipe-tag" data-tag="all">All</div>
                        {% endif %}
                    </div>
                    <button class="toggle-folders-btn" onclick="toggleTagsContainer()" title="Collapse tags">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                </div>
                
                <!-- Search container - similar structure to loras search -->
                {% include 'components/search_controls.html' %}
            </div>
            
            <!-- Recipe grid - similar to lora grid -->
            <div class="card-grid recipe-grid" id="recipeGrid">
                {% if recipes and recipes|length > 0 %}
                    {% for recipe in recipes %}
                        <div class="recipe-card" data-file-path="{{ recipe.file_path }}" data-title="{{ recipe.title }}" data-created="{{ recipe.created_date }}">
                            <div class="recipe-indicator" title="Recipe">R</div>
                            <div class="card-preview">
                                <img src="{{ recipe.file_url }}" alt="{{ recipe.title }}">
                                <div class="card-header">
                                    <div class="base-model-wrapper">
                                        {% if recipe.base_model %}
                                        <span class="base-model-label" title="{{ recipe.base_model }}">
                                            {{ recipe.base_model }}
                                        </span>
                                        {% endif %}
                                    </div>
                                    <div class="card-actions">
                                        <i class="fas fa-share-alt" title="Share Recipe"></i>
                                        <i class="fas fa-copy" title="Copy Recipe"></i>
                                        <i class="fas fa-trash" title="Delete Recipe"></i>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <div class="model-info">
                                        <span class="model-name">{{ recipe.title }}</span>
                                    </div>
                                    <div class="lora-count" title="Number of LoRAs in this recipe">
                                        <i class="fas fa-layer-group"></i> {{ recipe.loras|length }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="placeholder-message">
                        <p>No recipes found</p>
                        <p>Add recipe images to your recipes folder to see them here.</p>
                    </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <script type="module" src="/loras_static/js/recipes.js"></script>
    {% if is_initializing %}
    <script>
        // Check initialization status and set auto-refresh
        async function checkInitStatus() {
            try {
                const response = await fetch('/api/recipes?page=1&page_size=1');
                if (response.ok) {
                    // If data successfully retrieved, initialization is complete, refresh the page
                    window.location.reload();
                } else {
                    // If not yet complete, continue polling
                    setTimeout(checkInitStatus, 2000); // Check every 2 seconds
                }
            } catch (error) {
                // If error, continue polling
                setTimeout(checkInitStatus, 2000);
            }
        }
        
        // Start status checking
        checkInitStatus();
    </script>
    {% endif %}
    
    <!-- Recipe page specific scripts -->
    <script>
        // Toggle recipe tags container
        function toggleTagsContainer() {
            const container = document.querySelector('.recipe-tag-container');
            const button = document.querySelector('.toggle-folders-btn');
            
            if (container.style.display === 'none') {
                container.style.display = 'flex';
                button.querySelector('i').className = 'fas fa-chevron-up';
                button.title = 'Collapse tags';
            } else {
                container.style.display = 'none';
                button.querySelector('i').className = 'fas fa-chevron-down';
                button.title = 'Expand tags';
            }
        }
        
        // Refresh recipes
        function refreshRecipes() {
            // Will be implemented in recipes.js
            window.location.reload();
        }
        
        // Simple utility function to handle theme toggling
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
        }
        
        // Apply saved theme on load
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
            }
            
            // Setup recipe tag filtering
            document.querySelectorAll('.recipe-tag').forEach(tag => {
                tag.addEventListener('click', () => {
                    document.querySelectorAll('.recipe-tag').forEach(t => t.classList.remove('active'));
                    tag.classList.add('active');
                    
                    // Implement filtering logic here or in recipes.js
                    console.log('Filter by tag:', tag.dataset.tag);
                });
            });
        });
        
        // Placeholder for recipe filter manager
        const recipeFilterManager = {
            toggleFilterPanel() {
                const panel = document.getElementById('filterPanel');
                panel.classList.toggle('hidden');
            },
            
            closeFilterPanel() {
                document.getElementById('filterPanel').classList.add('hidden');
            },
            
            clearFilters() {
                // Clear filters and reset UI
                document.querySelectorAll('.filter-tags .tag.active').forEach(tag => {
                    tag.classList.remove('active');
                });
                
                document.getElementById('activeFiltersCount').style.display = 'none';
                
                // Reapply default view
                refreshRecipes();
            }
        };
    </script>
</body>
</html>